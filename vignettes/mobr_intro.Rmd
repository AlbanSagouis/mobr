---
title: "Analysis of scale-dependent biodiversity changes with mobr"
author: "Felix May and Dan McGlinn"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analysis of scale-dependent biodiversity changes with mobr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Installing `mobr`

The package `mobr` is currently available on GitHub and you can freely download 
the source code here [mobr on GitHub](https://github.com/MoBiodiv/mobr)

The easiest option is to install the package directly from GitHub using the package `devtools`. If you do not already have `devtools` installed then need to install it.

```{r, eval = F}
install.packages('devtools')
library(devtools)
install_github('MoBiodiv/mobr')
```

The package requires the `dplyr` package which has many depandances. If you do 
not already have the `dplyr` package installed we suggest you install it and 
all of its dependancies using:

```{r, eval=F}
install.packages('tidyverse')
```

Then check that `dplyr` can be loaded with `library(dplyr)`. 

# Data structure required by `mobr`

To work with `mobr` you need two matrix-like data tables:

1. Species abundance data in a community matrix (rows are sites and columns are species)
2. A site attributes table (rows are sites and columns are site attributes)

The community matrix must include the number of individuals of each species.

The table with the plot attributes can include for instance spatial coordinates
of plots, experimental treatments and/or environmental variables. If spatial
coordinates are supplied they must be named "x" and "y" for the easting and
northing respectively. If temporal trends are of interest rather than 
spatial you simply set either x or y to a single number and put the temporal
measurement for the other coordinate. 

Throughout this vignette we use an example of a study on the effects of an
invasive plant Lonicera mackii on understory plant biodiversity in a Missouri
woodland (Powell et al. 2003)


This data set is included in `mobr`and available after

```{r, message=FALSE}
library(mobr)
data(inv_comm) # Community matrix
data(inv_plot_attr) # Plot attributes
```

```{r}
str(inv_comm)
head(inv_plot_attr)
```

The plot attributes include the information if a plot is located in invaded or
uninvaded sites as well as the spatial xy coordinates of a plot.

## Preparing data

In order to analyse the data with `mobr` the two data tables have to be combined
into on single object

```{r}
inv_mob_in <- make_mob_in(inv_comm, inv_plot_attr)
```

# Exploratory data analysis

The package `mobr` offers functions for exploratory data analysis and visualization.

First let's look at the spatial rarefaction curve in which samples are
added depending on their spatial proximity. 

```{r, fig.width = 7, fig.height=7}
plot_rarefaction(inv_mob_in, 'group', 'uninvaded', 'spat', lwd=2)
```

We can see that invasion decreases richness and that the magnitude of the effect
depends on scale. Let's dig in further to see if we can better understand
exactly what components of the community are changing due to invasion.

First we look at the individual rarefaction curves for each treatment which
only reflect the shape of the SAD (i.e., no individual density or aggregation effects):

```{r, fig.width = 7, fig.height=4}
par(mfrow=c(1,2))
plot_rarefaction(inv_mob_in, 'group', 'uninvaded', 'indiv', pooled=F, lwd=2,
                 leg_loc='topright')
plot_rarefaction(inv_mob_in, 'group', 'uninvaded', 'indiv', pooled=T, lwd=4,
                 leg_loc=NA)
```

Visually you can see there are some big differences in total numbers individuals
(i.e., how far on the x-axis the curves go). We can also see that for small 
numbers of individuals the invaded sites are actually more diverse! This is 
a bit surprising and it implies that the invaded sites have greater evenness. 
We can directly examine the species abundance distribution (SAD):

```{r, fig.width = 7, fig.height=4}
par(mfrow=c(1,2))
plot_abu(inv_mob_in, 'group', 'uninvaded', type='rad', pooled=F, log='x')
plot_abu(inv_mob_in, 'group', 'uninvaded', type='rad', pooled=T, log='x')
```

The SADs suggest that there are differences in the SADs where the invaded
site has greater evenness in its common species (i.e., flatter left hand-side 
of rank curve). 

# Two-scale analysis

The function `mob_stats` calculates the following biodiversity indices for every 
plot and for every groups defined by one grouping variable (e.g. experimental
treatment) defined by the user.

* N - Number of individuals
* S - Observed species richness
* S_rare - Rarefied species richness
* S_asymp - Estimated asymptotic species richness using biased corrected
* PIE - Probability of Interspecific Encounter (Hurlbert 1971)
* ENS_PIE - Effective number of species based on PIE (Jost 2007)

```{r}
inv_stats <- get_mob_stats(inv_mob_in, group_var = "group", 
                           ref_group = 'uninvaded', n_perm = 2)
```

We can examine the `inv_stats` object 
```{r}
names(inv_stats)
```

There are also functions for plotting the indices at the sample and group levels.
First let's examine the suite of biodiversity metrics

```{r, fig.width = 7, fig.height = 10}
plot(inv_stats, multi_panel = TRUE)
```


One of the major effects we observed in the individual rarefaction curve was 
that the invaded sites appeared to have fewer individuals, let's examine the 
test of that:

```{r, fig.width = 7, fig.height = 5}
plot(inv_stats, 'N')
```


# Continuous scale analysis

The complete analysis using `mobr` aims at disentangling the consequences of three
biodiversity components on observed changes in species richness

1. Species abundance distribution (SAD)
2. Number of individuals (N) 
3. Aggregation (clumping) of conspecific individuals

For the sake of speed we'll run the analysis with just 50 permutations but 
at least 500 are recommended for actual applications. 
```{r, include=FALSE}
inv_deltaS = get_delta_stats(inv_mob_in, 'group', ref_group='uninvaded',
                             type='discrete', log_scale=TRUE, nperm = 2)
```

```{r, fig.width=7, fig.height=7}
plot(inv_deltaS, 'invaded', 'uninvaded')
```

```{r, fig.width=7, fig.height=4}
par(mfrow=c(1,2))
overlap_effects(inv_deltaS, 'invaded', display='raw')
overlap_effects(inv_deltaS, 'invaded', display='stacked', prop=T)
```


# References

1. Powell, K.I., Chase, J.M. & Knight, T.M. (2013). Invasive Plants Have Scale-Dependent Effects on Diversity by Altering Species-Area Relationships. Science, 339, 316–318.

1. Gotelli, N.J. & Colwell, R.K. (2001). Quantifying biodiversity: procedures and pitfalls in the measurement and comparison of species richness. Ecology letters, 4, 379–391

1. Hurlbert, S.H. (1971). The Nonconcept of Species Diversity: A Critique and Alternative Parameters. Ecology, 52, 577–586

1. Jost, L. (2007). Partitioning Diversity into Independent Alpha and Beta Components. Ecology, 88, 2427-2439.
